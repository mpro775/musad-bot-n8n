# nginx/websocket.conf
# ✅ E2: إعداد WebSocket موحّد لـ /api/chat

# WebSocket configuration for /api/chat
location ^~ /api/chat/ {
    # WebSocket headers
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    
    # Standard proxy headers
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;
    
    # Request ID forwarding (للتوافق مع RequestIdMiddleware)
    proxy_set_header X-Request-Id $request_id;
    
    # WebSocket specific settings
    proxy_buffering off;
    proxy_cache off;
    
    # Timeouts for WebSocket connections
    proxy_read_timeout 86400s; # 24 hours for long-lived connections
    proxy_send_timeout 86400s;
    proxy_connect_timeout 60s;
    
    # Disable request/response buffering
    proxy_request_buffering off;
    proxy_response_buffering off;
    
    # Forward to backend
    proxy_pass http://backend_servers;
    
    # Security headers for WebSocket
    add_header X-Frame-Options DENY always;
    add_header X-Content-Type-Options nosniff always;
    
    # CORS handling (if needed, though Socket.IO handles this)
    if ($request_method = 'OPTIONS') {
        add_header Access-Control-Allow-Origin $http_origin always;
        add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS' always;
        add_header Access-Control-Allow-Headers 'Authorization, Content-Type, X-Request-Id' always;
        add_header Access-Control-Allow-Credentials true always;
        add_header Access-Control-Max-Age 86400 always;
        return 204;
    }
}

# Fallback for Socket.IO polling (if using polling transport)
location ^~ /api/chat/socket.io {
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    
    # Standard headers
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Request-Id $request_id;
    
    # Polling specific timeouts
    proxy_read_timeout 300s; # 5 minutes for polling
    proxy_send_timeout 300s;
    
    proxy_pass http://backend_servers;
}
