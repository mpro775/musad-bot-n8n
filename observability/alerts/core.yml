groups:
  - name: core
    rules:
      - alert: APIHighErrorRate
        expr: sum(rate(http_requests_total{job="api",status=~"5.."}[5m])) 
              / sum(rate(http_requests_total{job="api"}[5m])) > 0.05
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "API 5xx > 5% لمدة 5 دقائق"
          description: "تحقق من لوجات api و backend."

      - alert: RabbitMQQueueBacklog
        expr: rabbitmq_queue_messages{queue=~".*\\.q$"} > 1000
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "RabbitMQ backlog مرتفع"
          description: "الطابور {{ $labels.queue }} تجاوز 1000 رسالة."

      - alert: InstanceHighCPU
        expr: rate(container_cpu_usage_seconds_total[5m]) > 0.8
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "CPU > 80% لوقت طويل"
          description: "تحقق من الخدمة: {{ $labels.container_label_com_docker_compose_service }}"

      - alert: QdrantDown
        expr: up{job="cadvisor"} < 1 and on() vector(0) == 0   # بديل سريع
        for: 5m
        labels: { severity: critical }
        annotations:
          summary: "تحقق من qdrant"
          description: "جرّب healthcheck و/أو راقب اللوجات عبر Loki."
