# Runbook: High 5xx Error Rate

## الأعراض

- ارتفاع في عدد أخطاء HTTP 5xx (Internal Server Error, Bad Gateway, etc.) في Grafana.
- تنبيهات من Alertmanager تشير إلى `HighErrorRate`.
- شكاوى من المستخدمين تفيد بوجود مشاكل في الوصول إلى الخدمة.

## تشخيص

1.  **تحقق من لوحة مراقبة Grafana:** افتح لوحة مراقبة الأداء الرئيسية وابحث عن الارتباط بين ارتفاع الأخطاء وأي من المقاييس التالية:
    *   `http_requests_total{status=~"5.."}`: لتحديد المسارات (routes) التي تسبب الأخطاء.
    *   `node_cpu_seconds_total`, `node_memory_usage_bytes`: للتحقق من وجود ضغط على موارد الخادم.
    *   `mongodb_connections`, `database_query_duration_seconds`: للتحقق من وجود مشاكل في قاعدة البيانات.
2.  **فحص سجلات Loki:** استخدم Request ID من السجلات للبحث عن الأخطاء وتتبع مسار الطلب عبر الخدمات.
3.  **مراجعة التغييرات الأخيرة:** تحقق من آخر عمليات النشر (deployments) أو التغييرات في الإعدادات التي قد تكون سببت المشكلة.

## حلول فورية

-   **إعادة تشغيل الخدمة:** إذا كان الخطأ ناتجًا عن حالة غير متوقعة، قد تساعد إعادة تشغيل الخدمة في حل المشكلة مؤقتًا.
-   **التراجع عن التغييرات:** إذا تم تحديد تغيير حديث كسبب للمشكلة، قم بالتراجع عنه فورًا.

## حلول دائمة

-   **إصلاح الكود:** قم بتحليل الخطأ في الكود المسبب للمشكلة وإصلاحه.
-   **تحسين الاستعلامات:** إذا كانت المشكلة تتعلق بقاعدة البيانات، قم بتحسين الاستعلامات أو إضافة فهارس (indexes).
-   **زيادة الموارد:** إذا كان هناك ضغط على الموارد، قم بزيادة موارد الخادم أو تحسين استخدامها.

## Postmortem

-   **تحليل السبب الجذري:** قم بتوثيق السبب الجذري للمشكلة.
-   **الإجراءات المتخذة:** وثق الإجراءات التي تم اتخاذها لحل المشكلة.
-   **الدروس المستفادة:** سجل الدروس المستفادة لمنع تكرار المشكلة في المستقبل.

