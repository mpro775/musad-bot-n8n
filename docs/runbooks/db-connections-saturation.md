# Runbook: DB Connections Saturation

## الأعراض

- ارتفاع في عدد اتصالات قاعدة البيانات في Grafana.
- تنبيهات من Alertmanager تشير إلى `DBConnectionsSaturation`.
- أخطاء في التطبيق تشير إلى عدم القدرة على الاتصال بقاعدة البيانات.

## تشخيص

1.  **تحقق من لوحة مراقبة Grafana:** افتح لوحة مراقبة قاعدة البيانات وابحث عن:
    *   `mongodb_connections{state="current"}`: للتحقق من عدد الاتصالات الحالية.
    *   `database_query_duration_seconds`: للتحقق من وجود استعلامات بطيئة قد تحجز الاتصالات لفترة طويلة.
2.  **فحص سجلات التطبيق:** ابحث عن أي أخطاء تتعلق بالاتصال بقاعدة البيانات.
3.  **مراجعة إعدادات pool الاتصالات:** تحقق من إعدادات `maxPoolSize` في إعدادات الاتصال بقاعدة البيانات.

## حلول فورية

-   **زيادة `maxPoolSize`:** قم بزيادة `maxPoolSize` مؤقتًا إذا كان العدد الحالي غير كافٍ.
-   **إعادة تشغيل التطبيق:** قد تساعد إعادة تشغيل التطبيق في تحرير الاتصالات العالقة.

## حلول دائمة

-   **تحسين الاستعلامات:** قم بتحسين الاستعلامات البطيئة لتقليل مدة حجز الاتصالات.
-   **ضبط `maxPoolSize`:** قم بضبط `maxPoolSize` بناءً على حمل العمل الفعلي.
-   **استخدام فهارس (indexes):** تأكد من وجود فهارس مناسبة لجميع الاستعلامات.

## Postmortem

-   **تحليل السبب الجذري:** قم بتوثيق السبب الجذري للمشكلة.
-   **الإجراءات المتخذة:** وثق الإجراءات التي تم اتخاذها لحل المشكلة.
-   **الدروس المستفادة:** سجل الدروس المستفادة لمنع تكرار المشكلة في المستقبل.

